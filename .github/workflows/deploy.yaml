name: Build and Deploy to Cloud Run

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: false
        default: 'production'
        type: choice
        options:
          - production
          - staging

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  SERVICE_NAME: pdf-to-markdown
  REGION: us-central1
  IMAGE_NAME: gcr.io/${{ secrets.GCP_PROJECT_ID }}/pdf-to-markdown
  TORCH_DEVICE: cpu
  MARKER_PORT: 8001

jobs:
  build-and-deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest

    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
      # Checkout code
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Set up Docker Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Configure Docker to use gcloud as a credential helper
      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      # Set up Cloud SDK
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      # Configure Docker to use gcloud as a credential helper
      - name: Configure Docker credential helper
        run: gcloud auth configure-docker

      # Cache Docker layers
      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      # Build Docker image with BuildKit
      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ${{ env.IMAGE_NAME }}:${{ github.sha }}
            ${{ env.IMAGE_NAME }}:latest
          cache-from: type=local,src=/tmp/.buildx-cache
          cache-to: type=local,dest=/tmp/.buildx-cache-new,mode=max
          build-args: |
            TORCH_DEVICE=${{ env.TORCH_DEVICE }}
            NODE_ENV=production

      # Move cache
      - name: Move cache
        run: |
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache

      # Deploy to Cloud Run
      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy ${{ env.SERVICE_NAME }} \
            --image=${{ env.IMAGE_NAME }}:${{ github.sha }} \
            --region=${{ env.REGION }} \
            --platform=managed \
            --port=3000 \
            --memory=4Gi \
            --cpu=2 \
            --timeout=3600 \
            --max-instances=10 \
            --min-instances=0 \
            --allow-unauthenticated \
            --set-env-vars=TORCH_DEVICE=${{ env.TORCH_DEVICE }},MARKER_PORT=${{ env.MARKER_PORT },NODE_ENV=production,NEXT_TELEMETRY_DISABLED=1,PYTHONUNBUFFERED=1 \
            --labels=commit-sha=${{ github.sha }},workflow-run=${{ github.run_number }},environment=${{ github.event.inputs.environment || 'production' }}

      # Get service URL
      - name: Get Service URL
        id: service-url
        run: |
          SERVICE_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
            --region=${{ env.REGION }} \
            --format='value(status.url)')
          echo "url=$SERVICE_URL" >> $GITHUB_OUTPUT
          echo "=========================================="
          echo "Service deployed successfully!"
          echo "=========================================="
          echo "Service URL: $SERVICE_URL"
          echo "Health Check: $SERVICE_URL/api/health"
          echo "=========================================="

      # Wait for service to be ready
      - name: Wait for service to be ready
        run: |
          echo "Waiting for service to be ready..."
          sleep 10
          max_attempts=30
          attempt=0
          while [ $attempt -lt $max_attempts ]; do
            if curl -f ${{ steps.service-url.outputs.url }}/api/health; then
              echo "Service is ready!"
              exit 0
            fi
            attempt=$((attempt + 1))
            echo "Attempt $attempt/$max_attempts failed, retrying..."
            sleep 5
          done
          echo "Service did not become ready in time"
          exit 1

      # Add comment to PR/Issue
      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## Deployment Complete âœ…
              
              **Environment:** ${{ github.event.inputs.environment || 'production' }}
              
              **Service URL:** ${{ steps.service-url.outputs.url }}
              
              **Commit:** \`${{ github.sha }}\`
              
              **Workflow Run:** #${{ github.run_number }}
              
              ---
              *Automated deployment by GitHub Actions*`
            })

  deploy-gpu:
    name: Deploy with GPU (Optional)
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Configure Docker
        run: gcloud auth configure-docker

      - name: Build and Push GPU image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ${{ env.IMAGE_NAME }}-gpu:${{ github.sha }}
            ${{ env.IMAGE_NAME }}-gpu:latest
          build-args: |
            TORCH_DEVICE=cuda
            NODE_ENV=production

      - name: Deploy to Cloud Run with GPU
        run: |
          gcloud run deploy ${{ env.SERVICE_NAME }}-gpu \
            --image=${{ env.IMAGE_NAME }}-gpu:${{ github.sha }} \
            --region=${{ env.REGION }} \
            --platform=managed \
            --accelerator type=nvidia-l4,count=1 \
            --memory=16Gi \
            --cpu=8 \
            --timeout=3600 \
            --max-instances=5 \
            --min-instances=0 \
            --allow-unauthenticated \
            --set-env-vars=TORCH_DEVICE=cuda,MARKER_PORT=${{ env.MARKER_PORT },NODE_ENV=production,NEXT_TELEMETRY_DISABLED=1,PYTHONUNBUFFERED=1

      - name: Get GPU Service URL
        id: gpu-service-url
        run: |
          SERVICE_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }}-gpu \
            --region=${{ env.REGION }} \
            --format='value(status.url)')
          echo "url=$SERVICE_URL" >> $GITHUB_OUTPUT
          echo "GPU Service deployed: $SERVICE_URL"

  notify-on-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    if: failure()
    needs: build-and-deploy
    
    steps:
      - name: Send notification
        run: |
          echo "Deployment failed!"
          echo "Workflow: ${{ github.workflow }}"
          echo "Run: ${{ github.run_number }}"
          echo "Commit: ${{ github.sha }}"
